<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.project.chaser.mapper.CommentMapper">

    <!-- 댓글 + 대댓글 목록 -->
    <select id="getComments" resultType="com.project.chaser.dto.Comment">
        SELECT
        c.CommentIdx,
        c.SnsIdx,
        c.UserIdx,
        c.CommentContent,
        c.CreatedAt,
        u.Nickname AS userNickname,
        c.ParentIdx
        FROM comments c
        JOIN user u ON c.UserIdx = u.UserIdx
        WHERE c.SnsIdx = #{snsIdx}
        ORDER BY COALESCE(c.ParentIdx, c.CommentIdx) ASC, c.CreatedAt ASC
    </select>

    <!-- 댓글/대댓글 등록 -->
    <insert id="insertComment" parameterType="com.project.chaser.dto.Comment" useGeneratedKeys="true" keyProperty="CommentIdx">
        INSERT INTO comments (SnsIdx, UserIdx, CommentContent, ParentIdx)
        VALUES (#{SnsIdx}, #{UserIdx}, #{CommentContent}, #{ParentIdx})
    </insert>

    <!-- 1. 대댓글 개수 확인 쿼리: ParentIdx 참조 -->
    <select id="countReplies" resultType="int">
        SELECT
        COUNT(*)
        FROM
        comments
        WHERE
        ParentIdx = #{parentIdx} <!-- @Param("parentIdx")와 일치 -->
        AND IsDeleted = FALSE <!-- 삭제되지 않은 대댓글만 카운트 -->
    </select>

    <!-- 2. 소프트 삭제 쿼리: CommentContent='삭제되었습니다.'로 UPDATE -->
    <update id="deleteComment">
        UPDATE
        comments
        SET
        CommentContent = '',
        IsDeleted = TRUE
        WHERE
        CommentIdx = #{commentIdx}
        AND
        UserIdx = #{userIdx}
    </update>

    <!-- 3. 하드 삭제 쿼리: DB에서 레코드 완전히 제거 -->
    <delete id="hardDeleteComment">
        DELETE FROM
        comments
        WHERE
        CommentIdx = #{commentIdx}
        AND
        UserIdx = #{userIdx}
    </delete>
</mapper>
