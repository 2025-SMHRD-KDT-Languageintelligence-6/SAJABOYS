<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- MyBatis 프레임 워크 방식에 따라서 SQL문 관리 -->
<!-- namespace : 데이터베이스 관련 Mapper 인터페이스의 경로 설정
                    BoardMapper, TestMapper 등에서 쿼리 태그들의 id 중복되어도
                    namespace를 구분지어서 찾아감 -->
<mapper namespace="com.project.chaser.mapper.SnsMapper">
    <!-- 게시글 등록 -->
    <insert id="insertPost" parameterType="com.project.chaser.dto.Sns" useGeneratedKeys="true" keyProperty="snsIdx">
        insert into sns (SnsTitle, SnsContent, Category, UserIdx)
        values (#{SnsTitle}, #{SnsContent}, #{Category}, #{UserIdx})
    </insert>

    <!-- 게시글 수정 -->
    <update id="updateSns" parameterType="com.project.chaser.dto.Sns">
        update sns set SnsTitle = #{SnsTitle}, SnsContent = #{SnsContent}, Category = #{Category} WHERE SnsIdx = #{SnsIdx}
    </update>

    <!-- 게시글 삭제 -->
    <delete id="deletePost">
        delete from sns where SnsIdx = #{SnsIdx}
    </delete>

    <!-- 파일 등록 -->
    <insert id="insertFile" parameterType="com.project.chaser.dto.Snsfile">
        insert into snsfile (SnsIdx, FileName, FilePath, FileSize, FileType)
        values (#{SnsIdx}, #{FileName}, #{FilePath}, #{FileSize}, #{FileType})
    </insert>

    <!-- 게시글 상세 -->
    <select id="getPost" parameterType="int" resultType="com.project.chaser.dto.Sns">
        select s.*, u.Nickname as userNickname
        from sns s left join user u on s.UserIdx = u.UserIdx
        where s.SnsIdx = #{SnsIdx}
    </select>

    <update id="updateViews">
        update sns set SnsViews = SnsViews + 1 where SnsIdx = #{SnsIdx} <!-- 조회수 증가 -->
    </update>

    <!-- 파일 리스트 -->
    <select id="getFiles" parameterType="int" resultType="com.project.chaser.dto.Snsfile">
        select * from snsfile where SnsIdx = #{SnsIdx} order by FileIdx asc
    </select>

    <!-- 게시글 목록 -->

    <select id="getTotalCount" resultType="int">
        select count(*) from sns
    </select>

    <select id="getPostListByPage" resultType="com.project.chaser.dto.Sns">
        select s.SnsIdx, s.SnsTitle, s.Category, s.UserIdx, s.CreatedAt, s.SnsViews, u.Nickname as UserNickname
        from sns s left join user u on s.UserIdx = u.UserIdx order by SnsIdx desc LIMIT #{start}, #{pageSize}
    </select>

    <!-- 게시글 검색 -->

    <select id="getTotalCountBySearch" resultType="int" parameterType="map">
        SELECT COUNT(*)
        FROM sns s
        JOIN user u ON s.UserIdx = u.UserIdx
        WHERE 1=1
        <if test="category != null and category != ''">
            AND s.Category = #{category}
        </if>
        <if test="keyword != null and keyword != ''">
            AND (s.SnsTitle LIKE CONCAT('%', #{keyword}, '%')
            OR s.SnsContent LIKE CONCAT('%', #{keyword}, '%')
            OR u.Nickname LIKE CONCAT('%', #{keyword}, '%'))
        </if>
    </select>

    <select id="getPostListByPageWithSearch" resultType="com.project.chaser.dto.Sns" parameterType="map">
        SELECT s.SnsIdx, s.SnsTitle, s.Category, s.UserIdx, s.CreatedAt, s.SnsViews, u.Nickname as UserNickname
        FROM sns s
        JOIN user u ON s.UserIdx = u.UserIdx
        WHERE 1=1
        <if test="category != null and category != ''">
            AND s.Category = #{category}
        </if>
        <if test="keyword != null and keyword != ''">
            AND (s.SnsTitle LIKE CONCAT('%', #{keyword}, '%')
            OR s.SnsContent LIKE CONCAT('%', #{keyword}, '%')
            OR u.Nickname LIKE CONCAT('%', #{keyword}, '%'))
        </if>
        ORDER BY s.CreatedAt DESC
        LIMIT #{start}, #{pageSize}
    </select>




</mapper>