<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ê²Œì„ ì‹¤í–‰ | ì¶”ì ì</title>

  <!-- Verti ê³µí†µ CSS -->
  <link rel="stylesheet" href="/static/css/main.css" />

  <!-- ì¸ê²Œì„ ì „ìš© CSS -->
  <link rel="stylesheet" href="/static/css/game-play.css" />

  <!-- Leaflet ì§€ë„ ë¼ì´ë¸ŒëŸ¬ë¦¬ (ë¬´ë£Œ / OpenStreetMap) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>
</head>
<body class="is-preload">
        

<div id="page-wrapper">

  <!-- header include -->
	<div id="site-header"></div>
	<script src="/assets/js/header.js"></script>

  <!-- ìƒë‹¨ ê²Œì„ íƒ€ì´í‹€ ë°” -->
  <div class="game-header">
    <h1>ê±°ì  íƒí—˜ì „ â€“ ê²Œì„ ì‹¤í–‰</h1>
    <div>í˜„ì¬ ìƒíƒœ: <strong>ì§„í–‰ ì¤‘</strong></div>
  </div>

  <!-- ë‹¨ì„œ ë°°ë„ˆ -->
  <div id="clueBanner" class="clue-banner">
    <span>ë‹¨ì„œ!!!</span> í´ë¦­í•˜ì„¸ìš”
  </div>

  <!-- ë©”ì¸ ë ˆì´ì•„ì›ƒ -->
  <main class="game-layout">

    <!-- ì¢Œì¸¡: ì‹œê°„ + ì ìˆ˜ -->
    <section class="panel">
      <div class="time-badge">
        ì œí•œì‹œê°„
        <span id="timeDisplay">01:30:00</span>
      </div>

      <div class="score-box">
        ì ìˆ˜
        <span id="scoreValue" class="value">1400</span>
      </div>

      <div class="info-small">
        Â· ë¯¸ì…˜ ì„±ê³µ ì‹œ ì ìˆ˜ ì¦ê°€<br>
        Â· ì œí•œì‹œê°„ì´ ëë‚˜ë©´ ê²Œì„ì´ ìë™ ì¢…ë£Œë©ë‹ˆë‹¤.
      </div>
    </section>

    <!-- ì¤‘ì•™: ì§€ë„ -->
    <section style="position:relative;">
      <div id="map"></div>
    </section>

    <!-- ìš°ì¸¡: ë­í‚¹ + QR -->
    <section class="panel">
      <h3 style="margin:0 0 .4rem 0;">ë­í‚¹</h3>
      <table class="ranking-table">
        <thead>
          <tr>
            <th>í”Œë ˆì´ì–´</th>
            <th style="text-align:right;">ì ìˆ˜</th>
          </tr>
        </thead>
        <tbody id="rankingBody">
          <tr><td>ë£¨í”¼ ğŸ‘‘</td><td style="text-align:right;">5000</td></tr>
          <tr><td>ë‚˜ë¯¸</td><td style="text-align:right;">4000</td></tr>
          <tr><td>ì¡°ë¡œ</td><td style="text-align:right;">3000</td></tr>
          <tr><td>ë‚˜</td><td style="text-align:right;">1400</td></tr>
          <tr><td>ìš°ì†</td><td style="text-align:right;">500</td></tr>
        </tbody>
      </table>

      <div class="qr-box">
        <div style="font-size:1.1rem;font-weight:700;">QR / ì‚¬ì§„ ì°ê¸°</div>
        <small>ë¯¸ì…˜ ì¥ì†Œì—ì„œ QRì„ ìŠ¤ìº”í•˜ê±°ë‚˜ ì¸ì¦ìƒ·ì„ ì´¬ì˜í•˜ì„¸ìš”.</small>
        <button type="button" class="button alt" id="cameraBtn">ì¹´ë©”ë¼ ì—´ê¸°</button>
        <div class="camera-preview" id="cameraBox" style="display:none;">
          <video id="video" autoplay playsinline></video>
        </div>
      </div>
    </section>

  </main>

  <!-- í‘¸í„° (ì›í•˜ë©´ ì‚­ì œ ê°€ëŠ¥) -->
  <div id="footer-wrapper">
    <div class="container" id="footer">
      <div id="copyright">
        <ul class="menu">
          <li>&copy; 2025 RunBack</li>
          <li>ì¶”ì ì Â· ê²Œì„ ì‹¤í–‰ í™”ë©´</li>
        </ul>
      </div>
    </div>
  </div>

</div>

<script>
  /**********************
   * 1. ì œí•œ ì‹œê°„ íƒ€ì´ë¨¸ (1ì‹œê°„ 30ë¶„)
   **********************/
  const timeDisplay = document.getElementById('timeDisplay');
  let remaining = 90 * 60; // 90ë¶„ = 5400ì´ˆ

  function formatTime(sec){
    const h = String(Math.floor(sec / 3600)).padStart(2,'0');
    const m = String(Math.floor((sec % 3600) / 60)).padStart(2,'0');
    const s = String(sec % 60).padStart(2,'0');
    return `${h}:${m}:${s}`;
  }

  function tickTimer(){
    timeDisplay.textContent = formatTime(remaining);
    if(remaining <= 0){
      clearInterval(timerId);
      alert('ì œí•œ ì‹œê°„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
      return;
    }
    remaining--;
  }

  const timerId = setInterval(tickTimer, 1000);
  tickTimer();

  /**********************
   * 2. Leaflet ì§€ë„ ì´ˆê¸°í™”
   **********************/
  // ìˆœì²œë§Œ êµ­ê°€ì •ì› ê·¼ì²˜ ëŒ€ëµ ì¢Œí‘œ (ì›í•˜ë©´ ìˆ˜ì •)
  const initialLat = 34.9245;
  const initialLng = 127.5103;

  const map = L.map('map').setView([initialLat, initialLng], 15);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: 'Â© OpenStreetMap contributors'
  }).addTo(map);

  /**********************
   * 3. ëª©ì ì§€(ë¶‰ì€ ì›) í‘œì‹œ
   **********************/
  const targets = [
    { id:'A', lat:34.9248, lng:127.5088 },
    { id:'B', lat:34.9238, lng:127.5120 }
  ];
  const targetLayers = [];

  targets.forEach(t => {
    const circle = L.circle([t.lat, t.lng], {
      radius: 25,          // ì‹¤ì œ ê±°ë¦¬(ë¯¸í„°)
      color: 'red',
      fillColor: '#ff0000',
      fillOpacity: 0.15
    }).addTo(map);
    circle.targetId = t.id;
    targetLayers.push(circle);
  });

  /**********************
   * 4. í”Œë ˆì´ì–´ & ì°¸ê°€ì ìœ„ì¹˜(ì¡¸ë¼ë§¨)
   **********************/
  const stickIcon = L.divIcon({
    className: '',   // ê¸°ë³¸ í´ë˜ìŠ¤ ì œê±°
    html: 'ğŸƒ',      // ì¡¸ë¼ë§¨ ëŒ€ì‹  ë‹¬ë¦¬ê¸° ì´ëª¨ì§€
    iconSize: [24,24],
    iconAnchor: [12,12]
  });

  // ë‚´ ìœ„ì¹˜ (í”Œë ˆì´ì–´)
  const myMarker = L.marker([initialLat, initialLng], {icon: stickIcon}).addTo(map);

  // ì˜ˆì‹œ: ë‹¤ë¥¸ ì°¸ê°€ìë“¤ (ì„ì˜ ì¢Œí‘œ)
  const others = [
    [34.9250, 127.5098],
    [34.9242, 127.5110],
    [34.9239, 127.5079],
  ];
  others.forEach(pos => L.marker(pos, {icon: stickIcon}).addTo(map));

  // ì‹¤ì œ GPS ì—°ë™ (ê°€ëŠ¥í•˜ë©´ ì‚¬ìš©)
  if(navigator.geolocation){
    navigator.geolocation.watchPosition(
      pos => {
        const {latitude, longitude} = pos.coords;
        myMarker.setLatLng([latitude, longitude]);
        checkNearTarget();
      },
      err => console.warn('GPS ì˜¤ë¥˜:', err.message),
      { enableHighAccuracy:true, maximumAge:10000, timeout:10000 }
    );
  }

  /**********************
   * 5. ëª©ì ì§€ ë„ì°© ì—¬ë¶€ ì²´í¬
   **********************/
  const clueBanner = document.getElementById('clueBanner');
  let clueShownFor = null;

  function checkNearTarget(){
    const myPos = myMarker.getLatLng();
    targetLayers.forEach(circle => {
      const center = circle.getLatLng();
      const dist = map.distance(myPos, center); // meter
      if(dist < circle.getRadius()){ // ì› ì•ˆì— ë“¤ì–´ì˜´
        if(clueShownFor !== circle.targetId){
          clueShownFor = circle.targetId;
          showClueBanner(circle.targetId);
        }
      }
    });
  }

  function showClueBanner(targetId){
    clueBanner.style.display = 'flex';
    clueBanner.onclick = () => {
      clueBanner.style.display = 'none';
      alert('ë‹¨ì„œë¥¼ í™•ì¸í–ˆìŠµë‹ˆë‹¤! (ì—¬ê¸°ì— ì‹¤ì œ ë‹¨ì„œ/ë¯¸ì…˜ íŒì—…ì„ ì—°ê²°í•˜ì„¸ìš”)');
      // ì˜ˆ: ì ìˆ˜ ì¶”ê°€
      addScore(100);
    };
  }

  function addScore(delta){
    const el = document.getElementById('scoreValue');
    const current = parseInt(el.textContent, 10) || 0;
    el.textContent = current + delta;
  }

  // GPSê°€ ì•ˆë  ê²½ìš°ë¥¼ ìœ„í•´ ì§€ë„ í´ë¦­ìœ¼ë¡œ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥
  map.on('click', e => {
    myMarker.setLatLng(e.latlng);
    checkNearTarget();
  });

  /**********************
   * 6. ì¹´ë©”ë¼ ì—´ê¸° (QR/ì‚¬ì§„)
   **********************/
  const cameraBtn = document.getElementById('cameraBtn');
  const cameraBox = document.getElementById('cameraBox');
  const videoEl = document.getElementById('video');
  let stream = null;

  cameraBtn.addEventListener('click', async () => {
    if(stream){
      // ì´ë¯¸ ì¼œì ¸ ìˆìœ¼ë©´ ë„ê¸°
      stream.getTracks().forEach(t => t.stop());
      stream = null;
      cameraBox.style.display = 'none';
      cameraBtn.textContent = 'ì¹´ë©”ë¼ ì—´ê¸°';
      return;
    }

    try{
      stream = await navigator.mediaDevices.getUserMedia({
        video:{ facingMode:'environment' }
      });
      videoEl.srcObject = stream;
      cameraBox.style.display = 'block';
      cameraBtn.textContent = 'ì¹´ë©”ë¼ ë„ê¸°';
      // ì‹¤ì œ QR ì¸ì‹ì€ jsQR / html5-qrcode ê°™ì€ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì¶”ê°€í•´ì„œ êµ¬í˜„
    }catch(err){
      alert('ì¹´ë©”ë¼ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + err.message);
    }
  });
</script>

</body>
</html>
